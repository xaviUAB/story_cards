<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador d'Hist√≤ries - The Story Engine</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Personalitzaci√≥ de la barra de despla√ßament */
        .custom-scrollbar::-webkit-scrollbar {
            height: 12px;
            width: 12px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d4af37;
            border-radius: 6px;
            border: 3px solid #111;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #b5952f;
        }
        body {
            background-color: #1a1a1a;
            color: #e5e5e5;
            font-family: 'Times New Roman', serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #root {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        /* Contenidor per a l'input que s'adapta a l'amplada del text */
        .auto-width-container {
            display: inline-grid;
            align-items: center;
            position: relative;
            min-width: 40px;
        }
        .auto-width-container::after {
            content: attr(data-value) " ";
            visibility: hidden;
            white-space: pre;
            grid-area: 1/1;
            padding: 0 8px;
        }
        .auto-width-container input {
            grid-area: 1/1;
            width: 100%;
            background: transparent;
            border: none;
            text-align: center;
            outline: none;
            color: white;
            padding: 0 4px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, Fragment } = React;

        // --- Constants per a la c√†rrega remota ---
        const REMOTE_CONTENT_BASE_URL = 'https://raw.githubusercontent.com/xaviuab/story_cards/main/cartes/';
        const GITHUB_API_URL = "https://api.github.com/repos/xaviuab/story_cards/contents/cartes";

        // --- CONFIGURACI√ì DE CATEGORIES I ESTILS ---
        const CATEGORY_STYLES = {
            agent: { label: 'AGENT', type: 'quad', color: 'border-blue-400', bg: 'bg-blue-900/20', text: 'text-blue-200', promptBg: 'bg-blue-900/60' },
            engine: { label: 'MOTOR', type: 'binary', color: 'border-yellow-500', bg: 'bg-yellow-600/20', text: 'text-yellow-200', promptBg: 'bg-yellow-600/60' },
            anchor: { label: '√ÄNCORA', type: 'quad', color: 'border-emerald-500', bg: 'bg-emerald-900/20', text: 'text-emerald-200', promptBg: 'bg-emerald-900/60' },
            conflict: { label: 'CONFLICTE', type: 'binary', color: 'border-red-500', bg: 'bg-red-900/20', text: 'text-red-200', promptBg: 'bg-red-900/60' },
            aspect: { label: 'ASPECTE', type: 'quad', color: 'border-purple-500', bg: 'bg-purple-900/20', text: 'text-purple-200', promptBg: 'bg-purple-900/60' },
        };

        const GENERATION_MODES = {
            SEED: { id: 'SEED', label: 'Llavor de la Hist√≤ria', slots: ['agent', 'engine', 'anchor', 'conflict'] },
            CIRCLE: { id: 'CIRCLE', label: 'Cercle del Dest√≠', slots: ['agent', 'engine', 'conflict', 'agent', 'engine', 'conflict'] },
            CLASH: { id: 'CLASH', label: 'Xoc de Voluntats', slots: ['agent', 'engine', 'conflict', 'anchor', 'conflict', 'engine', 'agent'] },
            SOUL: { id: 'SOUL', label: 'Una √Änima Dividida', slots: ['agent', 'engine', 'conflict', 'anchor', 'engine', 'conflict', 'anchor'] }
        };

        // --- SISTEMA D'ICONES SVG MANUALS ---
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            const icons = {
                RotateCw: <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 12M21 3v9h-9"/>,
                Trash2: <Fragment><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Fragment>,
                Dices: <Fragment><rect width="12" height="12" x="2" y="10" rx="2" ry="2"/><path d="m17.92 14 3.5-3.5a2.24 2.24 0 0 0 0-3l-5-4.92a2.24 2.24 0 0 0-3 0L10 6"/><path d="M6 18h.01"/><path d="M10 14h.01"/><path d="M15 6h.01"/><path d="M18 9h.01"/></Fragment>,
                Database: <Fragment><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></Fragment>,
                BookOpen: <Fragment><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></Fragment>,
                ArrowRight: <Fragment><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></Fragment>,
                ArrowLeft: <Fragment><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></Fragment>,
                CheckSquare: <Fragment><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></Fragment>,
                Square: <rect width="18" height="18" x="3" y="3" rx="2"/>,
                Repeat: <Fragment><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></Fragment>,
                X: <path d="M18 6 6 18M6 6l12 12"/>,
                Lock: <Fragment><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Fragment>,
                Loader: <Fragment><line x1="12" x2="12" y1="2" y2="6"/><line x1="12" x2="12" y1="18" y2="22"/><line x1="4.93" x2="7.76" y1="4.93" y2="7.76"/><line x1="16.24" x2="19.07" y1="16.24" y2="19.07"/><line x1="2" x2="6" y1="12" y2="12"/><line x1="18" x2="22" y1="12" y2="12"/><line x1="4.93" x2="7.76" y1="19.07" y2="16.24"/><line x1="16.24" x2="19.07" y1="7.76" y2="4.93"/></Fragment>,
                MoveRight: <path d="M18 8L22 12L18 16M2 12H22"/>,
                MoveDownLeft: <path d="M11 19H5V13M19 5L5 19"/>,
                MoveUpLeft: <path d="M5 11V5H11M5 5L19 19"/>,
                MoveUpRight: <path d="M13 5H19V11M19 5L5 19"/>,
                Check: <polyline points="20 6 9 17 4 12"/>,
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        // --- COMPONENTS DE CARTA ---
        const CardText = ({ position, text, color }) => {
            const textStyle = "text-center font-bold text-[10px] md:text-xs leading-tight tracking-wide pointer-events-none select-none px-2";
            if (position === 'top') return <div className={`absolute top-0 left-0 right-0 h-[40%] flex items-start justify-center pt-3 ${color}`}><span className={textStyle}>{text}</span></div>;
            if (position === 'bottom') return <div className={`absolute bottom-0 left-0 right-0 h-[40%] flex items-end justify-center pb-3 ${color}`}><span className={`${textStyle} transform rotate-180`}>{text}</span></div>;
            if (position === 'right') return <div className={`absolute top-0 bottom-0 right-0 w-[40%] flex items-center justify-end pr-1 ${color}`}><div className="w-[140px] h-8 flex items-center justify-center transform rotate-90 origin-center translate-x-[35%]"><span className={textStyle}>{text}</span></div></div>;
            if (position === 'left') return <div className={`absolute top-0 bottom-0 left-0 w-[40%] flex items-center justify-start pl-1 ${color}`}><div className="w-[140px] h-8 flex items-center justify-center transform -rotate-90 origin-center -translate-x-[35%]"><span className={textStyle}>{text}</span></div></div>;
            return null;
        };

        const CardComponent = ({ data, parentUid = null, isAspect = false, onRotate, onChange, style = {}, onMouseEnter }) => {
            if (!data) return null;
            const catConfig = CATEGORY_STYLES[data.category];
            return (
                <div className="relative group/card perspective-1000 cursor-pointer" onClick={(e) => { e.stopPropagation(); onRotate(isAspect ? data.uid : data.uid, data.category, isAspect, parentUid); }} onMouseEnter={onMouseEnter} style={style}>
                    {!isAspect && <div className="absolute -top-3 left-1/2 transform -translate-x-1/2 z-20 text-[#d4af37] animate-bounce pointer-events-none">‚ñº</div>}
                    <div className={`relative w-40 h-40 md:w-48 md:h-48 bg-[#0f0f0f] border-2 ${catConfig.color} rounded-lg shadow-[0_0_15px_rgba(0,0,0,0.5)] transition-transform duration-500 ease-in-out`} style={{ transform: `rotate(${data.rotation}deg)`, boxShadow: `0 0 20px ${catConfig.color.replace('border-', '')}20` }}>
                        <div className="absolute inset-0 opacity-20 pointer-events-none" style={{ backgroundImage: 'url("data:image/svg+xml,%3Csvg width=\'100\' height=\'100\' viewBox=\'0 0 100 100\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cfilter id=\'noise\'%3E%3CfeTurbulence type=\'fractalNoise\' baseFrequency=\'0.8\' numOctaves=\'3\' stitchTiles=\'stitch\'/%3E%3C/filter%3E%3Crect width=\'100%25\' height=\'100%25\' filter=\'url(%23noise)\' opacity=\'0.5\'/%3E%3C/svg%3E")' }}></div>
                        <div className="absolute inset-2 border border-white/5 rounded pointer-events-none"></div>
                        {catConfig.type === 'binary' ? (
                            <Fragment>
                                <CardText position="top" text={data.options[0]} color={catConfig.text} />
                                <CardText position="bottom" text={data.options[1]} color={catConfig.text} />
                                <div className="absolute top-1/2 left-2 right-2 h-px bg-white/10 transform -translate-y-1/2"></div>
                            </Fragment>
                        ) : (
                            <Fragment>
                                <CardText position="top" text={data.options[0]} color={catConfig.text} />
                                <CardText position="right" text={data.options[1]} color={catConfig.text} />
                                <CardText position="bottom" text={data.options[2]} color={catConfig.text} />
                                <CardText position="left" text={data.options[3]} color={catConfig.text} />
                            </Fragment>
                        )}
                        <div className="absolute inset-0 flex items-center justify-center z-50">
                            <div className={`w-10 h-10 rounded-full border-2 ${catConfig.color} flex items-center justify-center bg-[#1a1a1a] transition-all duration-300 shadow-lg group/center pointer-events-auto hover:bg-[#333] hover:scale-125 cursor-pointer`} onClick={(e) => { e.stopPropagation(); onChange(isAspect ? data.uid : data.uid, data.category, isAspect, parentUid); }}>
                                <div className={`w-6 h-6 rounded-full border ${catConfig.color} block group-hover/card:hidden`}></div>
                                <div style={{ transform: `rotate(${-data.rotation}deg)`, transition: 'transform 0.5s ease-in-out' }}>
                                    <Icon name="RotateCw" size={18} className="text-white hidden group-hover/card:block group-hover/center:hidden animate-pulse" />
                                    <Icon name="Trash2" size={18} className="text-red-400 hidden group-hover/center:block" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CardSlot = ({ card, activeAspects, toggleAspect, changeCard, rotateCard, canSwapType, onSwapType }) => {
            const [hoverTarget, setHoverTarget] = useState(null); 
            if (!card) return null; 
            const catConfig = CATEGORY_STYLES[card.category];
            const isAspectActive = (card.category === 'agent' || card.category === 'anchor') && card.aspectData && activeAspects[card.uid];
            let mainZ = 20, aspectZ = 30;
            if (hoverTarget === 'main') { mainZ = 50; aspectZ = 30; } 
            else if (hoverTarget === 'aspect') { aspectZ = 50; mainZ = 20; }

            return (
                <div key={card.uid} className={`flex flex-col items-center gap-2 relative pointer-events-auto transition-all duration-300 ${hoverTarget ? 'z-[100]' : 'z-0'} shrink-0`} onMouseLeave={() => setHoverTarget(null)}>
                    <div className="flex items-center gap-2 z-[60] bg-[#1a1a1a]/80 px-2 py-1 rounded-full border border-white/5 backdrop-blur-sm">
                        <div className={`text-[10px] tracking-[0.2em] font-bold ${catConfig.text} uppercase`}>{catConfig.label}</div>
                        <div className="flex items-center gap-1 border-l border-white/20 pl-2 ml-1">
                            {canSwapType && <button onClick={() => onSwapType(card.uid)} className="text-gray-400 hover:text-white transition-colors" title="Canviar tipus"><Icon name="Repeat" size={14} /></button>}
                            {(card.category === 'agent' || card.category === 'anchor') && 
                                <button onClick={() => toggleAspect(card.uid)} className={`transition-colors hover:text-[#d4af37] ${isAspectActive ? 'text-[#d4af37]' : 'text-gray-600'}`} title="Activar Aspecte">
                                    <Icon name={isAspectActive ? "CheckSquare" : "Square"} size={14} />
                                </button>
                            }
                        </div>
                    </div>
                    <div className="relative">
                        {isAspectActive && <div className="absolute top-12 left-4 transform -rotate-3 transition-all duration-300" style={{ zIndex: aspectZ }}><CardComponent data={card.aspectData} parentUid={card.uid} isAspect={true} onRotate={rotateCard} onChange={changeCard} onMouseEnter={(e) => { e.stopPropagation(); setHoverTarget('aspect'); }} /></div>}
                        <div className="relative transition-all duration-300" style={{ zIndex: mainZ }}><CardComponent data={card} onRotate={rotateCard} onChange={changeCard} onMouseEnter={(e) => { e.stopPropagation(); setHoverTarget('main'); }} /></div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function StoryEngineApp() {
            const [appStatus, setAppStatus] = useState('SETUP'); 
            const [availableDecks, setAvailableDecks] = useState([]);
            const [selectedDecks, setSelectedDecks] = useState(new Set());
            const [currentMode, setCurrentMode] = useState('SEED');
            const [hand, setHand] = useState([]); 
            const [cardPool, setCardPool] = useState({ agent: [], engine: [], anchor: [], conflict: [], aspect: [] });
            const [usedIndices, setUsedIndices] = useState({});
            const [promptOrder, setPromptOrder] = useState([]); 
            const [manualEdits, setManualEdits] = useState({}); 
            const [showInstructions, setShowInstructions] = useState(false);
            const [activeAspects, setActiveAspects] = useState({}); 

            // 1. DESCOBERTA DE FITXERS (GITHUB API)
            useEffect(() => {
                const discoverDecks = async () => {
                    const foundFiles = [];
                    const seenNames = new Set();
                    try {
                        const response = await fetch(GITHUB_API_URL);
                        if (response.ok) {
                            const data = await response.json();
                            data.filter(item => item.name.toLowerCase().endsWith('.csv')).forEach(item => {
                                if (!seenNames.has(item.name)) {
                                    seenNames.add(item.name);
                                    foundFiles.push({ id: item.name, url: REMOTE_CONTENT_BASE_URL + item.name });
                                }
                            });
                        }
                    } catch (e) { console.warn("GitHub API error"); }
                    
                    // Fallback pels fitxers que segur que existeixen si el llistat falla
                    const mandatoryFiles = ['cat - Gen√®ric.csv', 'cat - SciFi.csv'];
                    for (const f of mandatoryFiles) {
                        if (!seenNames.has(f)) {
                            foundFiles.push({ id: f, url: REMOTE_CONTENT_BASE_URL + f });
                            seenNames.add(f);
                        }
                    }
                    setAvailableDecks(foundFiles);
                };
                discoverDecks();
            }, []);

            const loadSelectedDecks = async () => {
                setAppStatus('LOADING');
                const pools = { agent: [], engine: [], anchor: [], conflict: [], aspect: [] };
                try {
                    const selected = availableDecks.filter(d => selectedDecks.has(d.id));
                    for (const deck of selected) {
                        const response = await fetch(deck.url);
                        const text = await response.text();
                        const lines = text.split('\n').filter(line => line.trim() !== '');
                        const dataRows = lines.slice(1);
                        dataRows.forEach(row => {
                            const cols = row.split(';');
                            if (cols.length < 5) return;
                            if (cols[0]) pools.agent.push(cols[0].trim());
                            if (cols[1]) pools.engine.push(cols[1].trim());
                            if (cols[2]) pools.anchor.push(cols[2].trim());
                            if (cols[3]) pools.conflict.push(cols[3].trim());
                            if (cols[4]) pools.aspect.push(cols[4].trim());
                        });
                    }
                    setCardPool(pools);
                    const initialUsed = {};
                    Object.keys(pools).forEach(key => initialUsed[key] = new Set());
                    setUsedIndices(initialUsed);
                    setAppStatus('READY');
                } catch (e) {
                    setAppStatus('SETUP');
                    alert("Error carregant els fitxers CSV.");
                }
            };

            const toggleAspect = useCallback((uid) => {
                setActiveAspects(prev => ({ ...prev, [uid]: !prev[uid] }));
            }, []);

            const rotateCard = useCallback((uid, categoryKey, isAspect, parentUid) => {
                const degree = CATEGORY_STYLES[categoryKey].type === 'binary' ? 180 : 90;
                setHand(prev => prev.map(card => {
                    if (isAspect && card.uid === parentUid) return { ...card, aspectData: { ...card.aspectData, rotation: card.aspectData.rotation + degree } };
                    if (!isAspect && card.uid === uid) return { ...card, rotation: card.rotation + degree };
                    return card;
                }));
            }, []);

            const getUniqueRandomItems = useCallback((categoryKey, count) => {
                const pool = cardPool[categoryKey] || [];
                const used = usedIndices[categoryKey] || new Set();
                const result = [];
                const tempUsed = new Set(used);
                for (let i = 0; i < count; i++) {
                    let av = pool.map((_, idx) => idx).filter(idx => !tempUsed.has(idx));
                    if (av.length === 0) { tempUsed.clear(); av = pool.map((_, idx) => idx); }
                    if (av.length === 0) { result.push("..."); continue; }
                    const r = av[Math.floor(Math.random() * av.length)];
                    result.push(pool[r]);
                    tempUsed.add(r);
                }
                return { items: result, updatedUsed: tempUsed };
            }, [cardPool, usedIndices]);

            const changeCard = useCallback((uid, categoryKey, isAspect, parentUid) => {
                const count = CATEGORY_STYLES[categoryKey].type === 'binary' ? 2 : 4;
                const { items, updatedUsed } = getUniqueRandomItems(categoryKey, count);
                setHand(prev => prev.map(card => {
                    if (isAspect && card.uid === parentUid) return { ...card, aspectData: { ...card.aspectData, options: items, rotation: 0 } };
                    if (!isAspect && card.uid === uid) return { ...card, options: items, rotation: 0, aspectData: card.aspectData };
                    return card;
                }));
                setUsedIndices(prev => ({...prev, [categoryKey]: updatedUsed}));
            }, [getUniqueRandomItems]);

            const swapCardCategory = useCallback((uid) => {
                setHand(prevHand => prevHand.map(card => {
                    if (card.uid === uid) {
                        const newCat = card.category === 'agent' ? 'anchor' : 'agent';
                        const { items, updatedUsed } = getUniqueRandomItems(newCat, 4);
                        let aspectData = card.aspectData || { uid: `asp-new-${Math.random()}`, category: 'aspect', options: getUniqueRandomItems('aspect', 4).items, rotation: 0 };
                        return { ...card, category: newCat, options: items, rotation: 0, aspectData: aspectData };
                    }
                    return card;
                }));
            }, [getUniqueRandomItems]);

            const generateFullHand = useCallback(() => {
                if (appStatus !== 'READY') return;
                const modeConfig = GENERATION_MODES[currentMode];
                const newHand = [];
                let currentUsedIndices = { ...usedIndices };

                const getItemsLocally = (cat, cnt) => {
                    const pool = cardPool[cat] || [];
                    const used = currentUsedIndices[cat] || new Set();
                    const result = [];
                    for(let i=0; i<cnt; i++) {
                        let available = pool.map((_, idx) => idx).filter(idx => !used.has(idx));
                        if(available.length === 0) { used.clear(); available = pool.map((_, idx) => idx); }
                        if (available.length === 0) { result.push("..."); continue; }
                        const randomIdx = available[Math.floor(Math.random() * available.length)];
                        result.push(pool[randomIdx] || "...");
                        used.add(randomIdx);
                    }
                    currentUsedIndices[cat] = used;
                    return result;
                };

                modeConfig.slots.forEach((catKey, index) => {
                    const count = CATEGORY_STYLES[catKey].type === 'binary' ? 2 : 4;
                    const items = getItemsLocally(catKey, count);
                    let aspectData = null;
                    if (catKey === 'agent' || catKey === 'anchor') {
                        aspectData = { uid: `asp-${index}-${Math.random()}`, category: 'aspect', options: getItemsLocally('aspect', 4), rotation: 0 };
                    }
                    newHand.push({ uid: `${catKey}-${index}-${Math.random()}`, category: catKey, options: items, rotation: 0, aspectData: aspectData });
                });
                setHand(newHand);
                setUsedIndices(currentUsedIndices);
                setManualEdits({});
                setPromptOrder(newHand.map(card => card.uid));
                setActiveAspects({});
            }, [appStatus, currentMode, cardPool, usedIndices]);

            useEffect(() => { if (appStatus === 'READY') generateFullHand(); }, [appStatus, currentMode]);

            const getActiveText = (obj) => {
                if(!obj) return "";
                if(manualEdits[obj.uid]) return manualEdits[obj.uid];
                const conf = CATEGORY_STYLES[obj.category];
                if (!conf) return "";
                const r = (Math.abs(obj.rotation) / (conf.type === 'binary' ? 180 : 90)) % (conf.type === 'binary' ? 2 : 4);
                if(conf.type === 'binary') return r === 0 ? obj.options[0] : obj.options[1];
                return obj.options[r === 0 ? 0 : (r === 1 ? 3 : (r === 2 ? 2 : 1))];
            };

            const handleDrop = (e, dropIdx) => {
                const dragIdx = Number(e.dataTransfer.getData('idx'));
                const newO = [...promptOrder];
                const item = newO[dragIdx];
                newO.splice(dragIdx, 1);
                newO.splice(dropIdx, 0, item);
                setPromptOrder(newO);
            };

            if (appStatus === 'SETUP') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="max-w-md w-full bg-[#222] border-2 border-[#d4af37] rounded-lg p-8 shadow-2xl">
                            <h1 className="text-3xl font-bold text-[#d4af37] text-center mb-8 uppercase tracking-widest border-b border-[#d4af37] pb-4">Story Engine</h1>
                            <div className="space-y-4">
                                <p className="text-gray-400 text-center mb-6">Baralles CSV detectades:</p>
                                <div className="space-y-3 max-h-64 overflow-y-auto custom-scrollbar pr-2">
                                    {availableDecks.length === 0 && (
                                        <div className="flex flex-col items-center py-4">
                                            <Icon name="Loader" className="animate-spin text-[#d4af37] mb-2" size={32} />
                                            <p className="text-xs italic text-gray-500">Cercant fitxers...</p>
                                        </div>
                                    )}
                                    {availableDecks.map(deck => (
                                        <div key={deck.id} onClick={() => {
                                            const next = new Set(selectedDecks);
                                            if (next.has(deck.id)) next.delete(deck.id); else next.add(deck.id);
                                            setSelectedDecks(next);
                                        }} className={`flex items-center p-4 rounded-md cursor-pointer border transition-all ${selectedDecks.has(deck.id) ? 'bg-[#d4af37]/20 border-[#d4af37]' : 'bg-[#111] border-gray-800'}`}>
                                            <div className={`w-5 h-5 rounded border flex items-center justify-center ${selectedDecks.has(deck.id) ? 'bg-[#d4af37] border-[#d4af37]' : 'border-gray-500'}`}>
                                                {selectedDecks.has(deck.id) && <Icon name="Check" size={14} className="text-black" />}
                                            </div>
                                            <span className="ml-3 text-sm font-medium">{deck.id.replace('.csv', '')}</span>
                                        </div>
                                    ))}
                                </div>
                                <button disabled={selectedDecks.size === 0} onClick={loadSelectedDecks} className={`w-full mt-6 py-4 rounded font-bold uppercase tracking-widest transition-all ${selectedDecks.size > 0 ? 'bg-[#d4af37] text-black hover:bg-[#b5952f] shadow-lg' : 'bg-gray-700 text-gray-500 cursor-not-allowed'}`}>
                                    Comen√ßar C√†rrega
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (appStatus === 'LOADING') return <div className="min-h-screen flex flex-col items-center justify-center"><Icon name="RotateCw" className="animate-spin text-[#d4af37] mb-4" size={48} /><p className="uppercase tracking-widest text-[#d4af37]">Preparant la baralla...</p></div>;

            // --- L√íGICA DE RENDER DEL PROMPT ---
            const renderPromptElements = () => {
                if (appStatus !== 'READY' || hand.length === 0) return null;
                
                let order = [];
                if (currentMode === 'SOUL') {
                    if (hand.length < 7) return null;
                    order = [
                        { type: 'card', uid: hand[0].uid },
                        { type: 'card', uid: hand[1].uid },
                        { type: 'card', uid: hand[3].uid },
                        { type: 'card', uid: hand[2].uid },
                        { type: 'separator', text: ' i tamb√© ' },
                        { type: 'card', uid: hand[4].uid },
                        { type: 'card', uid: hand[6].uid },
                        { type: 'card', uid: hand[5].uid }
                    ];
                } else if (currentMode === 'CLASH') {
                    if (hand.length < 7) return null;
                    // Agent 1 (0), Motor 1 (1), √Äncora (3), Conflicte 1 (2), "Al mateix temps", Agent 2 (6), Motor 2 (5), √Äncora (Ref: 3), Conflicte 2 (4)
                    order = [
                        { type: 'card', uid: hand[0].uid },
                        { type: 'card', uid: hand[1].uid },
                        { type: 'card', uid: hand[3].uid },
                        { type: 'card', uid: hand[2].uid },
                        { type: 'separator', text: ' Al mateix temps ' },
                        { type: 'card', uid: hand[6].uid },
                        { type: 'card', uid: hand[5].uid },
                        { type: 'card', uid: hand[3].uid, isRef: true, refLabel: "√Äncora (Rep.)" },
                        { type: 'card', uid: hand[4].uid }
                    ];
                } else if (currentMode === 'CIRCLE') {
                    if (hand.length < 6) return null;
                    // Cercle: Ag1(0), Mot1(1), Ag2(3)ref, Con1(2), Ag2(3), Mot2(4), Ag1(0)ref, Con2(5)
                    order = [
                        { type: 'card', uid: hand[0].uid },
                        { type: 'card', uid: hand[1].uid },
                        { type: 'card', uid: hand[3].uid, isRef: true, refLabel: "Agent (2)" },
                        { type: 'card', uid: hand[2].uid },
                        { type: 'card', uid: hand[3].uid },
                        { type: 'card', uid: hand[4].uid },
                        { type: 'card', uid: hand[0].uid, isRef: true, refLabel: "Agent (1)" },
                        { type: 'card', uid: hand[5].uid }
                    ];
                } else {
                    order = promptOrder.map(uid => ({ type: 'card', uid }));
                }

                return order.map((item, idx) => {
                    if (item.type === 'separator') {
                        return <div key={`sep-${idx}`} className="flex items-center px-2 pt-4 text-[#d4af37] font-bold italic opacity-80">{item.text}</div>;
                    }

                    const card = hand.find(c => c.uid === item.uid);
                    if (!card) return null;
                    const txt = getActiveText(card);
                    const isDrag = currentMode === 'SEED';

                    return (
                        <div key={`${card.uid}-${idx}`} className="flex flex-col gap-1 p-1 rounded border border-transparent">
                            <div className={`p-2 rounded shadow-lg ${CATEGORY_STYLES[card.category].promptBg} border border-white/10 flex flex-col items-center`}>
                                <span className="text-[8px] uppercase font-bold opacity-70 tracking-tighter">
                                    {item.isRef ? item.refLabel : CATEGORY_STYLES[card.category].label}
                                </span>
                                <div className="auto-width-container" data-value={txt}>
                                    <input type="text" value={txt} readOnly={item.isRef} onChange={e => !item.isRef && setManualEdits(p=>({...p, [card.uid]: e.target.value}))} onMouseDown={e=>e.stopPropagation()} />
                                </div>
                            </div>
                            {card.aspectData && activeAspects[card.uid] && !item.isRef && (
                                <div className="p-2 rounded bg-purple-900/60 border border-white/10 flex flex-col items-center scale-90">
                                    <span className="text-[8px] uppercase font-bold opacity-70 tracking-tighter">ASPECTE</span>
                                    <div className="auto-width-container" data-value={getActiveText(card.aspectData)}>
                                        <input type="text" value={getActiveText(card.aspectData)} onChange={e => setManualEdits(p=>({...p, [card.aspectData.uid]: e.target.value}))} onMouseDown={e=>e.stopPropagation()} className="text-xs" />
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                });
            };

            return (
                <div className="flex flex-col min-h-screen overflow-x-hidden">
                    <header className="pt-8 px-4 text-center space-y-4 relative z-20">
                        <h1 className="text-3xl md:text-5xl font-bold tracking-widest text-[#d4af37] uppercase border-b-2 border-[#d4af37] pb-2 inline-block">GENERADOR D'HIST√íRIES</h1>
                        <div className="flex flex-wrap justify-center gap-4 items-center">
                            <select value={currentMode} onChange={(e) => setCurrentMode(e.target.value)} className="bg-[#2a2a2a] border border-[#d4af37] text-[#d4af37] py-2 px-4 rounded focus:outline-none uppercase text-xs font-bold">
                                {Object.values(GENERATION_MODES).map(m => <option key={m.id} value={m.id}>{m.label}</option>)}
                            </select>
                            <button onClick={() => setShowInstructions(true)} className="px-4 py-2 bg-transparent border border-gray-600 text-gray-400 rounded hover:border-[#d4af37] hover:text-[#d4af37] transition-all flex items-center gap-2 text-xs">
                                <Icon name="BookOpen" size={16} /> Instruccions
                            </button>
                        </div>
                        <div className="mt-8 p-4 border-t border-b border-gray-800 bg-[#111] flex flex-wrap justify-center gap-3 min-h-[80px]">
                            {renderPromptElements()}
                        </div>
                    </header>

                    <main className="flex-grow flex items-center justify-center py-12 px-4">
                        {currentMode === 'SOUL' ? (
                            <div className="w-full max-w-[100vw] overflow-x-auto pb-16 pt-32 px-4 custom-scrollbar"> 
                                <div className="flex flex-col items-center gap-8 min-w-max mx-auto px-12 relative">
                                    <div className="flex flex-nowrap items-center gap-8">
                                        {/* Extrem Esquerre: CONFLICTE 2 (5) -> √ÄNCORA 2 (6) -> MOTOR 2 (4) */}
                                        <div className="flex flex-row items-center gap-4 order-1">
                                            <CardSlot card={hand[5]} activeAspects={activeAspects} toggleAspect={toggleAspect} changeCard={changeCard} rotateCard={rotateCard} />
                                            <Icon name="ArrowLeft" className="text-[#d4af37] shrink-0 opacity-40" size={24} />
                                            <CardSlot card={hand[6]} activeAspects={activeAspects} toggleAspect={toggleAspect} changeCard={changeCard} rotateCard={rotateCard} canSwapType={true} onSwapType={swapCardCategory} />
                                            <Icon name="ArrowLeft" className="text-[#d4af37] shrink-0" size={24} />
                                            <CardSlot card={hand[4]} activeAspects={activeAspects} toggleAspect={toggleAspect} changeCard={changeCard} rotateCard={rotateCard} />
                                            <Icon name="ArrowLeft" className="text-[#d4af37] shrink-0" size={24} />
                                        </div>
                                        <div className="order-2 z-20 transform scale-110 mx-4">
                                            <CardSlot card={hand[0]} activeAspects={activeAspects} toggleAspect={toggleAspect} changeCard={changeCard} rotateCard={rotateCard} canSwapType={true} onSwapType={swapCardCategory} />
                                        </div>
                                        {/* Extrem Dret: MOTOR 1 (1) -> √ÄNCORA 1 (3) -> CONFLICTE 1 (2) */}
                                        <div className="flex flex-row items-center gap-4 order-3">
                                            <Icon name="ArrowRight" className="text-[#d4af37] shrink-0" size={24} />
                                            <CardSlot card={hand[1]} activeAspects={activeAspects} toggleAspect={toggleAspect} changeCard={changeCard} rotateCard={rotateCard} />
                                            <Icon name="ArrowRight" className="text-[#d4af37] shrink-0" size={24} />
                                            <CardSlot card={hand[3]} activeAspects={activeAspects} toggleAspect={toggleAspect} changeCard={changeCard} rotateCard={rotateCard} canSwapType={true} onSwapType={swapCardCategory} />
                                            <Icon name="ArrowRight" className="text-[#d4af37] shrink-0 opacity-40" size={24} />
                                            <CardSlot card={hand[2]} activeAspects={activeAspects} toggleAspect={toggleAspect} changeCard={changeCard} rotateCard={rotateCard} />
                                        </div>
                                    </div>
                                    <div className="absolute -top-24 left-20 text-xs text-[#d4af37] uppercase tracking-widest font-bold bg-[#111] px-3 py-1 rounded border border-[#d4af37]/30 shadow-lg">Cam√≠ del Desig 2</div>
                                    <div className="absolute -top-24 right-20 text-xs text-[#d4af37] uppercase tracking-widest font-bold bg-[#111] px-3 py-1 rounded border border-[#d4af37]/30 shadow-lg">Cam√≠ del Desig 1</div>
                                </div>
                            </div>
                        ) : currentMode === 'CIRCLE' ? (
                            <div className="relative w-full max-w-4xl h-[650px] flex items-center justify-center">
                                <svg className="absolute inset-0 w-full h-full pointer-events-none opacity-20 animate-[spin_60s_linear_infinite]"><circle cx="50%" cy="50%" r="35%" stroke="#d4af37" strokeWidth="2" fill="none" strokeDasharray="10,5" /></svg>
                                {/* 0: Top (Ag1) */}
                                <div className="absolute top-0 left-1/2 transform -translate-x-1/2 z-10">
                                    <CardSlot card={hand[0]} activeAspects={activeAspects} toggleAspect={toggleAspect} changeCard={changeCard} rotateCard={rotateCard} canSwapType={true} onSwapType={swapCardCategory} />
                                    <Icon name="MoveRight" className="absolute -right-16 top-1/2 text-[#d4af37] rotate-[30deg]" size={40} />
                                </div>
                                {/* 1: Top Right (Mot1) */}
                                <div className="absolute top-[20%] right-0 md:right-20 z-10"><CardSlot card={hand[1]} activeAspects={activeAspects} toggleAspect={toggleAspect} changeCard={changeCard} rotateCard={rotateCard} /></div>
                                {/* 2: Bottom Right (Con1) */}
                                <div className="absolute bottom-[20%] right-0 md:right-20 z-10">
                                    <CardSlot card={hand[2]} activeAspects={activeAspects} toggleAspect={toggleAspect} changeCard={changeCard} rotateCard={rotateCard} />
                                    <Icon name="MoveDownLeft" className="absolute -left-16 bottom-0 text-[#d4af37] rotate-12" size={40} />
                                </div>
                                {/* 3: Bottom (Ag2) */}
                                <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 z-10">
                                    <CardSlot card={hand[3]} activeAspects={activeAspects} toggleAspect={toggleAspect} changeCard={changeCard} rotateCard={rotateCard} canSwapType={true} onSwapType={swapCardCategory} />
                                    <Icon name="MoveUpLeft" className="absolute -left-16 top-1/2 text-[#d4af37] rotate-12" size={40} />
                                </div>
                                {/* 4: Bottom Left (Mot2) */}
                                <div className="absolute bottom-[20%] left-0 md:left-20 z-20"><CardSlot card={hand[4]} activeAspects={activeAspects} toggleAspect={toggleAspect} changeCard={changeCard} rotateCard={rotateCard} /></div>
                                {/* 5: Top Left (Con2) */}
                                <div className="absolute top-[20%] left-0 md:left-20 z-10">
                                    <CardSlot card={hand[5]} activeAspects={activeAspects} toggleAspect={toggleAspect} changeCard={changeCard} rotateCard={rotateCard} />
                                    <Icon name="MoveUpRight" className="absolute -right-16 top-0 text-[#d4af37] rotate-12" size={40} />
                                </div>
                            </div>
                        ) : (
                            hand.length > 0 && (
                                <div className="flex flex-wrap justify-center gap-12 items-center">
                                    {hand.map((card, i) => (
                                        <Fragment key={`${card.uid}-${i}`}>
                                            {i > 0 && currentMode === 'SEED' && <Icon name="ArrowRight" className="text-[#d4af37]/30 hidden md:block" />}
                                            <CardSlot card={card} activeAspects={activeAspects} toggleAspect={toggleAspect} changeCard={changeCard} rotateCard={rotateCard} canSwapType={['agent','anchor'].includes(card.category)} onSwapType={swapCardCategory} />
                                        </Fragment>
                                    ))}
                                </div>
                            )
                        )}
                    </main>

                    {showInstructions && (
                        <div className="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-6">
                            <div className="bg-[#1a1a1a] border-2 border-[#d4af37] rounded-lg max-w-4xl w-full p-8 relative shadow-2xl max-h-[90vh] overflow-y-auto custom-scrollbar">
                                <button onClick={() => setShowInstructions(false)} className="absolute top-4 right-4 text-gray-500 hover:text-white"><Icon name="X" size={28} /></button>
                                <h2 className="text-3xl font-bold text-[#d4af37] mb-8 uppercase tracking-widest border-b border-gray-800 pb-2 text-center">Guia d'√ös: Generador d'Hist√≤ries</h2>
                                <div className="text-gray-300 space-y-8 text-sm md:text-base leading-relaxed">
                                    <section>
                                        <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Icon name="Database" size={20} className="text-[#d4af37]"/> 1. Els Tipus de Cartes</h3>
                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div className="p-3 bg-blue-900/20 border-l-4 border-blue-400"><strong>AGENT (üîµ):</strong> El Qui. El protagonista o for√ßa motriu.</div>
                                            <div className="p-3 bg-yellow-900/20 border-l-4 border-yellow-500"><strong>MOTOR (üü°):</strong> El Per qu√®. La motivaci√≥ o objectiu.</div>
                                            <div className="p-3 bg-emerald-900/20 border-l-4 border-emerald-500"><strong>√ÄNCORA (üü¢):</strong> El Qu√®/On. L'objectiu o lloc de l'acci√≥.</div>
                                            <div className="p-3 bg-red-900/20 border-l-4 border-red-500"><strong>CONFLICTE (üî¥):</strong> El Per√≤. L'obstacle o el preu que s'ha de pagar.</div>
                                            <div className="p-3 bg-purple-900/20 border-l-4 border-purple-500 col-span-full"><strong>ASPECTE (üü£):</strong> El Com. Modificadors de personatges o llocs.</div>
                                        </div>
                                    </section>
                                    <section>
                                        <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Icon name="RotateCw" size={20} className="text-[#d4af37]"/> 2. Com fer servir les cartes</h3>
                                        <ul className="list-disc pl-6 space-y-2">
                                            <li><strong>Girar:</strong> Clica la carta per triar entre les 4 opcions (90¬∫ cada clic).</li>
                                            <li><strong>Canviar:</strong> Clica el cercle central per rebre una carta nova del mateix tipus.</li>
                                            <li><strong>Aspectes:</strong> Usa la casella a la cap√ßalera de la carta per afegir un modificador a un Agent o √Äncora.</li>
                                            <li><strong>Intercanvi (‚Üî):</strong> En modes avan√ßats, pots transformar una √Äncora en un Agent.</li>
                                        </ul>
                                    </section>
                                    <section>
                                        <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Icon name="BookOpen" size={20} className="text-[#d4af37]"/> 3. Esquemes Narratius</h3>
                                        <div className="space-y-4">
                                            <p><strong>üå± Llavor:</strong> Estructura lineal b√†sica per a idees r√†pides.</p>
                                            <p><strong>‚≠ï Cercle:</strong> Relacions causa-efecte entre dos personatges atrapats en un cicle.</p>
                                            <p><strong>‚öîÔ∏è Xoc:</strong> Dos agents competint per un mateix objectiu compartit.</p>
                                            <p><strong>üíî Una √Änima Dividida:</strong> Un agent atrapat entre dos desitjos oposats.</p>
                                        </div>
                                    </section>
                                </div>
                            </div>
                        </div>
                    )}

                    <footer className="w-full bg-[#111] border-t border-gray-800 py-4 px-6 flex justify-between items-center text-xs text-gray-500 mt-auto">
                        <div>Una adaptaci√≥ de Xavier Ribes - Gamelab de la UAB</div>
                        <div className="flex items-center gap-2">
                            <Icon name="Database" size={14}/> 
                            {Object.values(cardPool.agent || {}).length * 4} possibilitats carregades
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StoryEngineApp />);
    </script>
</body>
</html>
